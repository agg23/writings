<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=content-type content="text/html"><meta name=viewport content="width=device-width,initial-scale=1"><title itemprop=name>FPGA Composite NTSC Video | Adam Gastineau's Writings</title><meta property="og:title" content="FPGA Composite NTSC Video | Adam Gastineau's Writings"><meta name=twitter:title content="FPGA Composite NTSC Video | Adam Gastineau's Writings"><meta itemprop=name content="FPGA Composite NTSC Video | Adam Gastineau's Writings"><meta name=application-name content="FPGA Composite NTSC Video | Adam Gastineau's Writings"><meta property="og:site_name" content><meta name=description content><meta itemprop=description content><meta property="og:description" content><meta name=twitter:description content><meta property="og:locale" content="en-us"><meta name=language content="en-us"><link rel=alternate hreflang=en-us href=https://example.org/posts/fpga-compositevideo/ title><meta property="og:type" content="article"><meta property="og:article:published_time" content=2023-08-23T11:13:09-0700><meta property="article:published_time" content=2023-08-23T11:13:09-0700><meta property="og:url" content="https://example.org/posts/fpga-compositevideo/"><meta property="og:article:author" content="Adam Gastineau"><meta property="article:author" content="Adam Gastineau"><meta name=author content="Adam Gastineau"><script defer type=application/ld+json>{"@context":"http://schema.org","@type":"Article","headline":"FPGA Composite NTSC Video","author":{"@type":"Person","name":""},"datePublished":"2023-08-23","description":"","wordCount":1307,"mainEntityOfPage":"True","dateModified":"2023-08-23","image":{"@type":"imageObject","url":""},"publisher":{"@type":"Organization","name":"Adam Gastineau\u0027s Writings"}}</script><meta name=generator content="Hugo 0.151.0"><meta property="og:url" content="https://example.org/posts/fpga-compositevideo/"><meta property="og:site_name" content="Adam Gastineau's Writings"><meta property="og:title" content="FPGA Composite NTSC Video"><meta property="og:description" content="This was originally published at https://github.com/agg23/fpga-compositevideo.
FPGA Composite NTSC Video This project records an experiment I made to attempt to output composite video via a FPGA; direct driving IO pins and without any complicated hardware. This implementation supports up to 6 levels of greys, and only requires wires and 3 resistors to build the psuedo-DAC.
Getting Started I started out on this project with a new devboard, the Tang Nano 9k. This gave me fast iteration times, and at least at the beginning, the joy of using a OSS toolchain. However, I quickly had to abandon the OSS toolchain due to lack of proper RAM support."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-08-23T11:13:09-07:00"><meta property="article:modified_time" content="2023-08-23T11:13:09-07:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="FPGA Composite NTSC Video"><meta name=twitter:description content="This was originally published at https://github.com/agg23/fpga-compositevideo.
FPGA Composite NTSC Video This project records an experiment I made to attempt to output composite video via a FPGA; direct driving IO pins and without any complicated hardware. This implementation supports up to 6 levels of greys, and only requires wires and 3 resistors to build the psuedo-DAC.
Getting Started I started out on this project with a new devboard, the Tang Nano 9k. This gave me fast iteration times, and at least at the beginning, the joy of using a OSS toolchain. However, I quickly had to abandon the OSS toolchain due to lack of proper RAM support."><link rel=canonical href=https://example.org/posts/fpga-compositevideo/><link href=/style.min.9a5e9c2fd75508c46e379b16cbcb83c71d03b959ea06034b9813d9a934b9de40.css rel=stylesheet><link href=/code-highlight.min.706d31975fec544a864cb7f0d847a73ea55ca1df91bf495fd12a177138d807cf.css rel=stylesheet><link rel=apple-touch-icon sizes=180x180 href=/icons/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/icons/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/icons/favicon-16x16.png><link rel=mask-icon href=/icons/safari-pinned-tab.svg><link rel="shortcut icon" href=/favicon.ico><link rel=manifest href=https://example.org/site.webmanifest><meta name=msapplication-config content="/browserconfig.xml"><meta name=msapplication-TileColor content="#2d89ef"><meta name=theme-color content="#434648"><link rel=icon type=image/svg+xml href=/icons/favicon.svg></head><body data-theme class=notransition><script src=/js/theme.min.8961c317c5b88b953fe27525839672c9343f1058ab044696ca225656c8ba2ab0.js integrity="sha256-iWHDF8W4i5U/4nUlg5ZyyTQ/EFirBEaWyiJWVsi6KrA="></script><div class=navbar role=navigation><nav class=menu aria-label="Main Navigation"><a href=https://example.org/ class=logo><svg width="25" height="25" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-home"><title>Home</title><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
</a><input type=checkbox id=menu-trigger class=menu-trigger>
<label for=menu-trigger><span class=menu-icon><svg width="25" height="25" stroke="currentColor" fill="none" viewBox="0 0 14 14"><title>Menu</title><path stroke-linecap="round" stroke-linejoin="round" d="M10.595 7H3.40726"/><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 3.51488H3.49301"/><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 10.4851H3.49301"/><path stroke-linecap="round" stroke-linejoin="round" d="M.5 12.5V1.5c0-.552285.447715-1 1-1h11C13.0523.5 13.5.947715 13.5 1.5v11C13.5 13.0523 13.0523 13.5 12.5 13.5H1.5C.947715 13.5.5 13.0523.5 12.5z"/></svg></span></label><div class=trigger><ul class=trigger-container><li><a class=menu-link href=/>Home</a></li><li><a class="menu-link active" href=/posts/>Posts</a></li><li><a class=menu-link href=https://github.com/agg23/>GitHub</a></li><li class=menu-separator><span>|</span></li></ul><a id=mode href=#><svg class="mode-sunny" width="21" height="21" viewBox="0 0 14 14" stroke-width="1"><title>LIGHT</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="7" y1=".5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1=".5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"/></g></svg>
<svg class="mode-moon" width="21" height="21" viewBox="0 0 14 14" stroke-width="1"><title>DARK</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="7" y1=".5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1=".5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"/></g></svg></a></div></nav></div><div class="wrapper post"><main class=page-content aria-label=Content><article><header class=header><h1 class=header-title>FPGA Composite NTSC Video</h1><div class=post-meta><time datetime=2023-08-23T11:13:09-07:00 itemprop=datePublished>Aug 23, 2023</time></div></header><details class=toc zgotmplz><summary><b>Table of Contents</b></summary><nav id=TableOfContents><ul><li><a href=#getting-started>Getting Started</a></li><li><a href=#fpga-implementation>FPGA Implementation</a></li><li><a href=#adding-more-bits>Adding More Bits</a></li><li><a href=#video-and-pocket-display>Video and Pocket Display</a></li></ul></nav></details><div class=page-content><p>This was originally published at <a href=https://github.com/agg23/fpga-compositevideo>https://github.com/agg23/fpga-compositevideo</a>.</p><h1 id=fpga-composite-ntsc-video>FPGA Composite NTSC Video</h1><figure><img src=/writings/external/fpga-compositevideo/assets/nesdisplay.png></figure><p>This project records an experiment I made to attempt to output composite video via a FPGA; direct driving IO pins and without any complicated hardware. This implementation supports up to 6 levels of greys, and only requires wires and 3 resistors to build the psuedo-DAC.</p><h2 id=getting-started>Getting Started</h2><p>I started out on this project with a new devboard, the <a href=https://wiki.sipeed.com/hardware/en/tang/Tang-Nano-9K/Nano-9K.html>Tang Nano 9k</a>. This gave me fast iteration times, and at least at the beginning, the joy of using a OSS toolchain. However, I quickly had to abandon the OSS toolchain due to lack of proper RAM support.</p><p>The general concept behind this project is creating a psuedo-DAC (digital to analog converter) using combinations of IO pins. Most projects that tried this used microcontrollers and two bits, which results in four total voltage values. NTSC requires a delta of 1V between the sync and brightest white levels, so naturally we target 0V-1V. Black then is placed at 0.3V.</p><p>The standard requires that TVs have an input impedience of 75 Ohms. Searching for a combination of resistors that can produce these target outputs (2 bit inputs, 3.3V driving voltage, 0.3V and 1.0V output) results in 450 Ohms and 900 Ohms. You can see a handy preview of the math below, stolen from the now dead Rickard Gunee website:</p><p><img src=/writings/external/fpga-compositevideo/assets/black2bit.png>
<img src=/writings/external/fpga-compositevideo/assets/grey2bit.png>
<img src=/writings/external/fpga-compositevideo/assets/white2bit.png></p><p><em><a href=https://web.archive.org/web/20181001053135/http://www.rickard.gunee.com/projects/video/pic/howto.php>See Archive.org</a></em></p><p>More on this math in a bit.</p><p>Now, if you wire up your circuit with two pins leading into each of the two resistors, with both of those tied to the positive pin of your RCA plug, theoretically you have everything you need to produce a NTSC video signal.</p><h2 id=fpga-implementation>FPGA Implementation</h2><p>In my initial implementation, I wanted to really understand the timing behind the NTSC signal, so I manually wrote my own timing code. Using the primary 27MHz clock of the Tang Nano 9k, I calculated the period of the clock, and determined the number of cycles needed in each of the sync signals. NTSC sync in black and white can be simplified down to:</p><ul><li>4,700ns per horizontal sync. This encompasses almost all of the hblank period, but TVs accept it</li><li>58,856ns per vertical sync or pixel output. This results in a total line length of 4,700ns + 58,856ns = 63,556ns</li><li>There are a total of 261 scanlines. One of those scanlines (I used 248, zero-indexed) output vsync, all others contain pixel data and hsync.</li></ul><p>This can then be converted into a simple state machine that puts our two pins low when in sync, defaults to 900 Ohms being on (black), and varies between 900 Ohm, 450 Ohm (grey), and 900 + 450 Ohm (white). I used this to produce a checkered pattern.</p><figure><img src=/writings/external/fpga-compositevideo/assets/checkereddisplay.png></figure><p>Following that, I went to display an image. After a long runaround trying to do things the <em>right</em> way (store greyscale image in Nano&rsquo;s flash, read it out to PSRAM, render from PSRAM) and being blocked by bad tooling, bad support, and possibly flawed hardware, I gave up and went with the simple solution. There isn&rsquo;t quite enough BRAM for a 256x240 (my target resolution) 8 bit image, so I scaled it to 4 bits, as we&rsquo;re not going to have 256 colors anyway. With the image baked into the BRAM, I now just needed to maintain the XY counts for each pixel. Due to my familiarity with the system, I choose to use the NES&rsquo;s system timings, matching exactly when the console would start/stop the sync pulses, as well as tracking what pixels are in overscan or not. This ended up being way simpler than the earlier method of tracking cycles absolutely (rather than per pixel).</p><p>This produced a nice image with surprising clarity. I chose my profile icon, not thinking about how dark it is (and thus not working well in black and white), but it seemed to turn out quite well.</p><figure><img src=/writings/external/fpga-compositevideo/assets/nabla2bit.png></figure><h2 id=adding-more-bits>Adding More Bits</h2><p>As an extension of the projects I&rsquo;d seen, I wanted to expand this system to 3 bits, and thus hopefully 7 colors. I very quickly realized that I didn&rsquo;t really understand the math discussed above; calculating the resulting voltage from the system. After much deliberation and playing, I arrived at the following equations:</p><pre tabindex=0><code>Let resistors be A, B, C, D (assuming 4 resistors)
Let A, B be pulled high, and C, D be pulled low
groundedPath = 1/(1/75 + 1/C + 1/D)

activePath = 1/(1/A + 1/B)

resultingVoltage = (groundedPath / (groundedPath + activePath)) * voltage
</code></pre><p>In other words:</p><ul><li>Resistors in series are added: <code>T = A + B + C</code></li><li>Resistors in parallel are the reciprocal of the reciprocals added: <code>1/T = 1/A + 1/B + 1/C</code></li><li>If a resistor is pulled low, it is in parallel with all other grounded resistors (all grounded resistors provide a separate path to ground, <em>including</em> the 75 Ohm TV impedience) (<code>groundedPath</code>)</li><li>If a resistor is pulled high, it is in parallel with all of the other high resistors (<code>activePath</code> adding reciprocals), and in series with the low resistors (<code>groundedPath + activePath</code>)</li><li>Dividing these two quantities and multiplying by our high voltage (3.3V) gets us our final voltage</li></ul><p>With that math out of the way, how do we form a system of equations to solve for the optimal resistor values for us? After many iterations of looking at this, I realized it&rsquo;s really not very easy and that I needed to approximate it the best I could. Some of the constraints looked like:</p><ul><li>We may not be able to hit the target voltages exactly (0.3V, 1.0V, everything in between), but we want to be as close as possible. Being too far away from 0.3V or 1.0V is super bad</li><li>We may not be able to use all permutations of resistors. Maybe resistor A, C high, B low results in a voltage that&rsquo;s out of range. We need to account for that</li></ul><p>In the end I built a solution you can find in <code>scripts/solver.ts</code>. I&rsquo;m sure it still has many problems, but it&rsquo;s now good enough.</p><p>I configured it with the resistor values that I own and ran it, solving for 3 bits. It produced the output:</p><pre tabindex=0><code>Best matches: [ 270, 330, 470 ]
Diff: 0.017571493125040277
None: 0
270: 0.5506745852430444
330: 0.4505519333806727
270, 330: 1.0012265186237168
470: 0.3163449745013234
270, 470: 0.8670195597443675
330, 470: 0.7668969078819959
270, 330, 470: 1.3175714931250402
</code></pre><p>This means our chosen resistor values are 270 Ohm, 330 Ohm, and 470 Ohm. The all high case results in 1.3V, so we can&rsquo;t use that output, but we can use all of the others, giving us a total of 6 colors.</p><p>Splitting up our 4 bits of image data into 6 approximately equal sections resulted in a rather dark image, as many of these voltages are on the lower side of things. I tweaked the ranges to contain more lighter colors, and got the decently nice output you can see below:</p><figure><img src=/writings/external/fpga-compositevideo/assets/nabla3bit.png></figure><p>I noticed that my image seemed off-center, so I tweaked the counter numbers a bit. I found that adding 15 pixels to hsync resulted in a much better centering on both of my screens.</p><h2 id=video-and-pocket-display>Video and Pocket Display</h2><p>Satisfied with my colors, I was finally able to wire this project up to the Analogue Pocket. As expected, the static image worked perfectly straight out of the box, using the link cable as our IO pins. I then wired up the NES core to use the same rendering system to the link port, including the same values for converting the greyscale values to 6 colors. I had to introduce a RGB to greyscale converter (it&rsquo;s not linear), but that was easy enough once I found an adequate example.</p><p>Hooking it all up produced the output I was hoping for; a surprisingly solid, good looking greyscale moving image of SMB on my CRT. I&rsquo;m not going to be playing any games this way, but it&rsquo;s still neat.</p><figure><img src=/writings/external/fpga-compositevideo/assets/nesdisplay.png></figure></div></article></main></div><footer class=footer><span class=footer_item></span>&nbsp;<div class=footer_social-icons></div><small class=footer_copyright>Â© 2025 Adam Gastineau.
Powered by <a href=https://github.com/hugo-sid/hugo-blog-awesome target=_blank rel=noopener>Hugo blog awesome</a>.</small></footer><a href=# title="Go to top" id=totop><svg width="48" height="48" fill="currentColor" stroke="currentColor" viewBox="0 96 960 960"><path d="M283 704.739 234.261 656 480 410.261 725.739 656 677 704.739l-197-197-197 197z"/></svg>
</a><script src=https://example.org/js/main.min.35f435a5d8eac613c52daa28d8af544a4512337d3e95236e4a4978417b8dcb2f.js integrity="sha256-NfQ1pdjqxhPFLaoo2K9USkUSM30+lSNuSkl4QXuNyy8="></script></body></html>